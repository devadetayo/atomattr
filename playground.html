<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AtomAttr - Playground</title>
    <meta name="description" content="Test and prototype with AtomAttr CSS instantly." />

    <!-- EDITOR LIB -->
    <script src="https://unpkg.com/codeflask/build/codeflask.min.js"></script>
    <link rel="icon" href="assets/favico/favico.png">
    <link rel="stylesheet" href="dist/defaults.css">
    <script src="dist/atomattr.min.js" defer></script>

    <!-- FONTS & ICONS -->
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <style>
        :root {
            /* UI Colors - Dark (Default) */
            --bg-app: #0f172a;
            --bg-panel: #1e293b;
            --bg-header: #1e293b;
            --border: #334155;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #6366f1;

            --scrollbar-track: #0f172a;
            --scrollbar-thumb: #334155;

            /* VS Code Dark Theme Colors (Slate) */
            --syntax-bg: #0f172a;
            --gutter-bg: #0f172a;
            --caret-color: #ffffff;

            /* Syntax Tokens */
            --token-tag: #569cd6;
            --token-attr: #9cdcfe;
            --token-val: #ce9178;
            --token-comment: #6a9955;
            --token-punct: #d4d4d4;
            --token-sel: #d7ba7d;
            --token-prop: #9cdcfe;
        }

        html.light-theme {
            --bg-app: #f8fafc;
            --bg-panel: #ffffff;
            --bg-header: #ffffff;
            --border: #cbd5e1;
            --text-main: #334155;
            --text-muted: #64748b;
            --accent: #4f46e5;

            --scrollbar-track: #ffffff;
            --scrollbar-thumb: #cbd5e1;

            --syntax-bg: #ffffff;
            --gutter-bg: #ffffff;
            --caret-color: #000000;

            --token-tag: #0000ff;
            --token-attr: #e00000;
            --token-val: #a31515;
            --token-comment: #008000;
            --token-punct: #333333;
            --token-sel: #800000;
            --token-prop: #e00000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- NAVBAR --- */
        nav {
            height: 3.5rem;
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 50;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-main);
            user-select: none;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            padding: 0.4rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: var(--border);
            color: var(--text-main);
        }

        .btn-active {
            color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            gap: 0.3rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 0.4rem 1rem;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .btn-primary:hover {
            background: var(--accent);
            opacity: 0.9;
            color: white;
        }

        .btn-share {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.4rem 1rem;
            font-weight: 500;
            font-size: 0.85rem;
            gap: 0.5rem;
        }

        .btn-share:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* --- WORKSPACE --- */
        #workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        #main-split {
            flex: 1;
            display: flex;
            flex-direction: row;
            min-width: 0;
        }

        #main-split.vertical {
            flex-direction: column;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
            background: var(--bg-panel);
            position: relative;
        }

        .panel-header {
            height: 2.5rem;
            padding: 0 1rem;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* --- EDITOR WRAPPERS --- */
        .editor-container {
            flex: 1;
            position: relative;
            background: var(--syntax-bg);
            overflow: hidden;
            min-height: 0;
        }

        /* CodeFlask Styling Overrides */
        .codeflask {
            position: absolute !important;
            width: 100% !important;
            height: 100% !important;
            background: transparent !important;
        }

        .codeflask__pre {
            z-index: 1;
            pointer-events: none;
        }

        .codeflask__textarea {
            z-index: 2;
            background: transparent !important;
            color: transparent !important;
            caret-color: var(--caret-color) !important;
            border: none !important;
            resize: none !important;
            outline: none !important;
            opacity: 1 !important;
        }

        .codeflask__pre,
        .codeflask__textarea,
        .codeflask__code,
        .codeflask__flatten {
            font-family: 'JetBrains Mono', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
            letter-spacing: normal !important;
            text-rendering: optimizeLegibility !important;
            font-variant-ligatures: none !important;
        }

        .codeflask__pre,
        .codeflask__textarea {
            padding: 1rem !important;
        }

        /* Word Wrap Support */
        .wrap-enabled .codeflask__pre,
        .wrap-enabled .codeflask__textarea {
            white-space: pre-wrap !important;
            overflow-x: hidden !important;
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 5px;
            border: 2px solid var(--scrollbar-track);
        }

        /* TOKENS */
        .token.comment {
            color: var(--token-comment) !important;
        }

        .token.punctuation {
            color: var(--token-punct) !important;
        }

        .token.tag {
            color: var(--token-tag) !important;
        }

        .token.attr-name {
            color: var(--token-attr) !important;
        }

        .token.attr-value {
            color: var(--token-val) !important;
        }

        .token.string {
            color: var(--token-val) !important;
        }

        .token.selector {
            color: var(--token-sel) !important;
        }

        .token.property {
            color: var(--token-prop) !important;
        }

        /* --- PREVIEW --- */
        #preview-wrapper {
            flex: 1;
            background: white;
            position: relative;
            min-height: 0;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #ffffff;
        }

        /* --- RESIZER --- */
        .resizer {
            background: var(--bg-app);
            border: 1px solid var(--border);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        #main-split:not(.vertical) .resizer {
            width: 12px;
            cursor: col-resize;
            border-top: none;
            border-bottom: none;
        }

        #main-split.vertical .resizer {
            height: 12px;
            cursor: row-resize;
            border-left: none;
            border-right: none;
        }

        /* --- CSS DRAWER --- */
        #css-drawer {
            width: 0;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            transition: width 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 40;
            position: relative;
        }

        #css-drawer.open {
            width: 350px;
        }

        #css-code-wrapper {
            flex: 1;
            background: var(--syntax-bg);
            position: relative;
            overflow: hidden;
        }

        #css-code-wrapper textarea {
            cursor: text;
        }

        #drag-overlay {
            position: absolute;
            inset: 0;
            z-index: 9999;
            display: none;
            cursor: grabbing;
        }

        body.resizing #drag-overlay {
            display: block;
        }

        /* TOAST NOTIFICATION */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
        }

        @media (max-width: 768px) {
            .hide-mobile {
                display: none;
            }

            #main-split {
                flex-direction: column !important;
            }

            #main-split:not(.vertical) .resizer {
                display: none;
            }

            #css-drawer {
                position: absolute;
                right: 0;
                height: 100%;
                z-index: 60;
                border-left: 1px solid var(--border);
            }

            .brand span {
                display: none;
            }

            /* Save space on mobile */
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav>
        <div class="brand">
            <a href="index.html" flex items="center" gap="3" group style="text-decoration: none;">
                <img src="assets/images/logo.png" w="8" h="auto">
                <span size="1.25rem" weight="700" tracking="-0.02em" text="#000" dark-text="#fff">AtomAttr</span>
                <span bg="surface-alt" border="1px" border-color="border" text="text-dim" size="0.7rem" px="1" py="0.5"
                    radius="md" weight="600" ml="2">PLAY</span>
            </a>
        </div>

        <div class="controls">
            <button class="btn hide-mobile" onclick="toggleLayout()" title="Toggle Layout">
                <i class="fa-solid fa-table-columns"></i>
            </button>
            <button class="btn" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fa-solid fa-circle-half-stroke"></i>
            </button>
            <button class="btn" onclick="toggleCss()" title="View CSS Output" id="css-btn">
                <i class="fa-brands fa-css3-alt"></i>
            </button>

            <div style="width: 1px; height: 1.2rem; background: var(--border); margin: 0 0.2rem;"></div>

            <button class="btn btn-share" onclick="shareCode()">
                <i class="fa-solid fa-share-nodes"></i> Share
            </button>
            <button class="btn btn-primary" onclick="forceRun()">
                <i class="fa-solid fa-play"></i> Run
            </button>
        </div>
    </nav>

    <!-- WORKSPACE -->
    <div id="workspace">
        <div id="main-split">
            <!-- HTML INPUT -->
            <div class="panel" id="pane-code" style="flex-basis: 50%;">
                <div class="panel-header">
                    <span><i class="fa-brands fa-html5" style="color: #e34c26; margin-right: 8px;"></i>
                        index.html</span>
                    <div class="panel-actions">
                        <button class="btn btn-sm" onclick="toggleWordWrap()" id="wrap-btn" title="Toggle Word Wrap">
                            <i class="fa-solid fa-align-left"></i>
                        </button>
                        <button class="btn btn-sm" onclick="formatHTML()" title="Format Code">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </button>
                        <button class="btn btn-sm" onclick="copyHTML()" title="Copy to Clipboard">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="editor-container" id="html-editor-wrapper"></div>
            </div>

            <!-- RESIZER -->
            <div class="resizer" id="resizer">
                <i class="fa-solid fa-grip-lines" style="font-size: 10px;"></i>
            </div>

            <!-- PREVIEW -->
            <div class="panel" id="pane-preview" style="flex-basis: 50%;">
                <div class="panel-header">
                    <span><i class="fa-solid fa-globe" style="color: var(--accent); margin-right: 8px;"></i>
                        Preview</span>
                    <span style="font-size: 0.7rem; opacity: 0.7;">Live Update</span>
                </div>
                <div id="preview-wrapper">
                    <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin allow-modals"></iframe>
                </div>
            </div>
        </div>

        <!-- CSS DRAWER -->
        <div id="css-drawer">
            <div class="panel-header">
                <span>Generated CSS</span>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn" onclick="togglePrettify()" title="Prettify CSS"
                        style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
                        <i class="fa-solid fa-code" style="margin-right: 4px;"></i> Prettify
                    </button>
                    <button onclick="toggleCss()" class="btn" style="padding: 0.2rem 0.5rem;">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            <div id="css-code-wrapper"></div>
        </div>

        <div id="drag-overlay"></div>
    </div>

    <!-- TOAST -->
    <div id="toast"><i class="fa-solid fa-check-circle"></i> <span>Link copied to clipboard!</span></div>

    <script>
        // --- 1. MOCK ATOM ENGINE LOGIC ---
        const AtomEngine = {
            colors: {
                'slate-100': '#f1f5f9', 'slate-200': '#e2e8f0', 'slate-500': '#64748b', 'slate-700': '#334155', 'slate-800': '#1e293b', 'slate-900': '#0f172a',
                'gray-100': '#f3f4f6', 'white': '#ffffff', 'black': '#000000',
                'indigo-100': '#e0e7ff', 'indigo-400': '#818cf8', 'indigo-600': '#4f46e5', 'indigo-700': '#4338ca', 'indigo-900': '#312e81'
            },
            sizes: {
                'sm': '0.125rem', 'md': '0.375rem', 'lg': '0.5rem', 'xl': '0.75rem', '2xl': '1rem', '3xl': '1.5rem', 'full': '100%'
            },
            generate(html) {
                const cssRules = new Set();
                const attrRegex = /([a-z0-9-]+)(?:="([^"]*)")?/gi;
                let match;
                while ((match = attrRegex.exec(html)) !== null) {
                    const attr = match[1];
                    const val = match[2];
                    if (!val) {
                        if (attr === 'flex') cssRules.add(`[flex] { display: flex; }`);
                        continue;
                    }
                    if (attr === 'bg' || attr === 'dark-bg' || attr === 'hover-bg') {
                        const color = this.colors[val] || val;
                        const prop = 'background-color';
                        if (attr === 'bg') cssRules.add(`[bg="${val}"] { ${prop}: ${color}; }`);
                        if (attr === 'dark-bg') cssRules.add(`.dark [dark-bg="${val}"] { ${prop}: ${color}; }`);
                        if (attr === 'hover-bg') cssRules.add(`[hover-bg="${val}"]:hover { ${prop}: ${color}; }`);
                    } else if (attr === 'text' || attr === 'dark-text') {
                        const color = this.colors[val] || val;
                        if (attr === 'text') cssRules.add(`[text="${val}"] { color: ${color}; }`);
                        if (attr === 'dark-text') cssRules.add(`.dark [dark-text="${val}"] { color: ${color}; }`);
                    } else if (attr.includes('border-color')) {
                        const color = this.colors[val] || val;
                        if (attr === 'border-color') cssRules.add(`[border-color="${val}"] { border-color: ${color}; }`);
                        if (attr === 'dark-border-color') cssRules.add(`.dark [dark-border-color="${val}"] { border-color: ${color}; }`);
                    } else if (['w', 'h', 'm', 'mt', 'mb', 'mx', 'my', 'p', 'pt', 'pb', 'px', 'py', 'gap'].includes(attr)) {
                        let cssVal = this.sizes[val] ? this.sizes[val] : (isNaN(val) ? val : `${val / 4}rem`);
                        const map = { w: 'width', h: 'height', m: 'margin', mt: 'margin-top', mb: 'margin-bottom', mx: 'margin-inline', my: 'margin-block', p: 'padding', pt: 'padding-top', pb: 'padding-bottom', px: 'padding-inline', py: 'padding-block', gap: 'gap' };
                        cssRules.add(`[${attr}="${val}"] { ${map[attr]}: ${cssVal}; }`);
                    } else if (attr === 'items') cssRules.add(`[items="${val}"] { align-items: ${val}; }`);
                    else if (attr === 'justify') cssRules.add(`[justify="${val}"] { justify-content: ${val}; }`);
                    else if (attr === 'flex' && val) cssRules.add(`[flex="${val}"] { flex: ${val}; }`);
                    else if (attr === 'text-align') cssRules.add(`[text-align="${val}"] { text-align: ${val}; }`);
                    else if (attr === 'radius') {
                        const rad = { 'sm': '2px', 'md': '4px', 'lg': '8px', 'xl': '12px', '2xl': '16px', 'full': '9999px' }[val] || val;
                        cssRules.add(`[radius="${val}"] { border-radius: ${rad}; }`);
                    } else if (attr === 'border') {
                        cssRules.add(`[border="${val}"] { border-width: ${val}; border-style: solid; }`);
                    } else if (attr === 'shadow') {
                        const s = val === 'xl' ? '0 20px 25px -5px rgb(0 0 0 / 0.1)' : '0 1px 3px 0 rgb(0 0 0 / 0.1)';
                        cssRules.add(`[shadow="${val}"] { box-shadow: ${s}; }`);
                    } else if (attr === 'hover-shadow') {
                        const s = val === 'xl' ? '0 20px 25px -5px rgb(0 0 0 / 0.1)' : '0 1px 3px 0 rgb(0 0 0 / 0.1)';
                        cssRules.add(`[hover-shadow="${val}"]:hover { box-shadow: ${s}; }`);
                    } else if (attr === 'transition') {
                        cssRules.add(`[transition="${val}"] { transition-property: ${val}; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }`);
                    } else if (attr === 'duration') {
                        cssRules.add(`[duration="${val}"] { transition-duration: ${val}ms; }`);
                    } else if (attr === 'hover-scale') {
                        cssRules.add(`[hover-scale="${val}"]:hover { transform: scale(${val}); }`);
                    } else if (attr === 'active-scale') {
                        cssRules.add(`[active-scale="${val}"]:active { transform: scale(${val}); }`);
                    } else if (attr === 'size') cssRules.add(`[size="${val}"] { font-size: ${val}; }`);
                    else if (attr === 'weight') cssRules.add(`[weight="${val}"] { font-weight: ${val}; }`);
                    else if (attr === 'leading') cssRules.add(`[leading="${val}"] { line-height: ${val}; }`);
                }
                return Array.from(cssRules).join('\n');
            }
        };

        // --- 2. EDITORS SETUP ---
        const flaskHTML = new CodeFlask('#html-editor-wrapper', { language: 'html', lineNumbers: true });
        const flaskCSS = new CodeFlask('#css-code-wrapper', { language: 'css', lineNumbers: true });
        const cssTextArea = document.querySelector('#css-code-wrapper textarea');
        if (cssTextArea) cssTextArea.setAttribute('readonly', 'true');

        // DOM Refs
        const previewFrame = document.getElementById('preview-frame');
        const cssDrawer = document.getElementById('css-drawer');
        const cssBtn = document.getElementById('css-btn');
        const resizer = document.getElementById('resizer');
        const mainSplit = document.getElementById('main-split');
        const paneCode = document.getElementById('pane-code');
        const wrapBtn = document.getElementById('wrap-btn');
        const toast = document.getElementById('toast');

        const DEFAULT_CODE = `<!-- AtomAttr Playground -->
<div flex items="center" justify="center" h="100vh" bg="slate-100" dark-bg="slate-900" text="slate-900" dark-text="slate-100" transition="all" duration="300">
    
    <div bg="white" dark-bg="slate-800" p="8" radius="2xl" shadow="xl" w="400px"
         text-align="center" border="1px" border-color="slate-200" dark-border-color="slate-700">
         
        <div w="4rem" h="4rem" bg="indigo-100" dark-bg="indigo-900" radius="lg" mx="auto" mb="4" flex items="center" justify="center" text="indigo-600" dark-text="indigo-400">
            <svg w="2rem" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>

        <h1 text="indigo-600" dark-text="indigo-400" size="2rem" weight="800" mb="2">Hello World</h1>
        
        <p text="slate-500" dark-text="slate-400" leading="1.6" mb="6">
            Edit this HTML. The engine generates the CSS instantly on the right. <br>
            Try changing <code bg="slate-100" dark-bg="slate-700" px="1" radius="sm">radius</code> to <code bg="slate-100" dark-bg="slate-700" px="1" radius="sm">full</code>.
        </p>
        
        <button bg="indigo-600" text="white" w="full" py="3" radius="xl" weight="600"
                hover-bg="indigo-700" hover-scale="1.05" active-scale="0.95" transition="all"
                shadow="lg" hover-shadow="xl" style="cursor: pointer; border:none;">
            Click Me
        </button>
    </div>

</div>`;

        // --- 3. INIT & LOAD LOGIC (Share + AutoSave) ---
        // Priority: 1. URL Param (Share) -> 2. LocalStorage -> 3. Default

        function getInitialCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedCode = urlParams.get('code');

            if (sharedCode) {
                try {
                    // Simple base64 decoding handling unicode
                    return decodeURIComponent(escape(window.atob(sharedCode)));
                } catch (e) {
                    console.error("Failed to decode share URL", e);
                }
            }

            const saved = localStorage.getItem('atomattr_code');
            if (saved) return saved;

            return DEFAULT_CODE;
        }

        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') document.documentElement.classList.add('light-theme');

        // Load Code
        const startCode = getInitialCode();
        flaskHTML.updateCode(startCode);


        // --- 4. CORE LOGIC ---
        let isPrettified = false;
        let lastGeneratedCSS = "";

        function togglePrettify() {
            isPrettified = !isPrettified;
            updateCSSDisplay(lastGeneratedCSS);
        }

        function prettifyCSS(css) {
            return css.replace(/ \{ /g, ' {\n    ').replace(/; \}/g, ';\n}\n').replace(/; /g, ';\n    ');
        }

        function updateCSSDisplay(css) {
            lastGeneratedCSS = css;
            const displayCSS = isPrettified ? prettifyCSS(css) : css;
            flaskCSS.updateCode(displayCSS || "/* No AtomAttr attributes found */");
        }

        function generateAndShowCSS(code) {
            const css = AtomEngine.generate(code);
            updateCSSDisplay(css);
            return css;
        }

        function updatePreview(code) {
            const css = AtomEngine.generate(code);
            const isLight = document.documentElement.classList.contains('light-theme');
            const html = `<!DOCTYPE html><html class="${isLight ? '' : 'dark'}"><head><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"><style>body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; }/* Generated by AtomAttr Engine */${css}</style></head><body>${code}</body></html>`;
            previewFrame.srcdoc = html;
        }

        // Debounce & Autosave Logic
        let timer;
        flaskHTML.onUpdate((code) => {
            // 1. Auto-save
            localStorage.setItem('atomattr_code', code);

            // 2. Update UI
            generateAndShowCSS(code);
            if (timer) clearTimeout(timer);
            timer = setTimeout(() => {
                updatePreview(code);
            }, 300);
        });

        // Initial Run
        generateAndShowCSS(startCode);
        updatePreview(startCode);

        // --- 5. CONTROLS ---

        function toggleTheme() {
            document.documentElement.classList.toggle('light-theme');
            const isLight = document.documentElement.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updatePreview(flaskHTML.getCode());
        }

        function toggleLayout() {
            mainSplit.classList.toggle('vertical');
            paneCode.style.flexBasis = '50%';
        }

        function toggleCss() {
            cssDrawer.classList.toggle('open');
            cssBtn.classList.toggle('btn-active', cssDrawer.classList.contains('open'));
        }

        function forceRun() {
            updatePreview(flaskHTML.getCode());
        }

        // Editor Utils
        function toggleWordWrap() {
            const editorDiv = document.getElementById('html-editor-wrapper');
            editorDiv.classList.toggle('wrap-enabled');
            wrapBtn.classList.toggle('btn-active');
        }

        function showToast(msg) {
            toast.innerHTML = `<i class="fa-solid fa-check-circle"></i> <span>${msg}</span>`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function copyHTML() {
            navigator.clipboard.writeText(flaskHTML.getCode()).then(() => showToast('Code copied to clipboard!'));
        }

        function shareCode() {
            const code = flaskHTML.getCode();
            try {
                // Encode code to Base64 (Unicode safe)
                const encoded = window.btoa(unescape(encodeURIComponent(code)));

                // Construct URL
                const url = new URL(window.location);
                url.searchParams.set('code', encoded);

                // Copy to clipboard
                navigator.clipboard.writeText(url.toString()).then(() => {
                    showToast('Share link copied to clipboard!');

                    // Optional: Update browser URL without reload so user sees the change
                    window.history.replaceState(null, '', url.toString());
                });
            } catch (e) {
                showToast('Error generating link (Code too large?)');
                console.error(e);
            }
        }

        function formatHTML() {
            const code = flaskHTML.getCode();
            const tab = '    ';
            let result = '';
            let indentLevel = 0;
            const xml = code.replace(/>\s*</g, '>\n<');
            xml.split('\n').forEach((line) => {
                line = line.trim();
                if (!line) return;
                if (line.match(/^<\//)) indentLevel = Math.max(0, indentLevel - 1);
                result += tab.repeat(indentLevel) + line + '\n';
                if (line.match(/^<[^/].*[^/]>$/) && !line.match(/<(img|br|hr|input|meta|link)/)) {
                    if (!line.includes('</')) indentLevel++;
                }
            });
            flaskHTML.updateCode(result.trim());
        }

        // --- 6. DRAG RESIZER ---
        let isResizing = false;
        resizer.addEventListener('mousedown', () => { isResizing = true; document.body.classList.add('resizing'); });
        document.addEventListener('mouseup', () => { isResizing = false; document.body.classList.remove('resizing'); });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const rect = mainSplit.getBoundingClientRect();
            const isVert = mainSplit.classList.contains('vertical');
            const percent = isVert ? ((e.clientY - rect.top) / rect.height) * 100 : ((e.clientX - rect.left) / rect.width) * 100;
            paneCode.style.flexBasis = Math.min(90, Math.max(10, percent)) + '%';
        });

    </script>
</body>

</html>